<!-- HTML header for doxygen 1.8.19-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.19"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ARM NEON Compositor: examples/perf_test/perf_test.py</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/SVG"],
});
</script>
<script type="text/javascript" async="async" src="/MathJax/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&family=Roboto:wght@400&family=Roboto:wght@500&display=block" rel="stylesheet">
<link href="../../custom_stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ARM NEON Compositor
   &#160;<span id="projectnumber"><code>master</code></span>
   </div>
   <div id="projectbrief">Fast SIMD alpha overlay and blending for ARM</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.19 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">examples/perf_test/perf_test.py</div>  </div>
</div><!--header-->
<div class="contents">
<h1><a class="anchor" id="autotoc_md0"></a>
Performance tests</h1>
<p>This example tests the performance of the <code>overlay_alpha*</code> functions with different sizes of random images. <br  />
 Ctypes is used to dynamically load the <code>alpha-lib</code> library in Python.</p>
<h2><a class="anchor" id="autotoc_md1"></a>
SIMD intrinsics</h2>
<p>The following two graphs show the results of four experiments comparing the performance of overlaying one image onto another, using GCC's <code>-O3</code> optimization level on the one hand, and using hand-crafted NEON intrinsics on the other hand. Especially for small images, the NEON version is much faster. For larger images, memory throughput and caching effects start to become more important factors than raw processing power, but the NEON version is still significantly faster than the version without intrinsics.</p>
<center> <img src="../../perf-small.svg" alt="" style="pointer-events: none;" class="inline" title="Performance SIMD intrinsics small images"/>   </center><center> <img src="../../perf-large.svg" alt="" style="pointer-events: none;" class="inline" title="Performance SIMD intrinsics large images"/>   </center><center> </center><h2><a class="anchor" id="autotoc_md2"></a>
Rounding methods</h2>
<p>The difference between the different scaling and rounding methods is negligible. As expected, an exact rounding division by 255 is slowest. An approximation is slightly faster, because it eliminates a vector load instruction to load the rounding constant. An exact flooring division by 255 is a tiny bit faster still.</p>
<p>The fastest option is to divide by 256 instead of 255, as both the rounding and flooring divisions by powers of two can be implemented using a single bit shift instruction. <br  />
 This does result in a small error in the output image. Most notably, combining two white pixels with color values <code>0xFF</code> will result in a slightly less white pixel, with color value <code>0xFE</code>.</p>
<center> <img src="../../perf-rescale-small.svg" alt="" style="pointer-events: none;" class="inline" title="Performance rescaling methods small images"/>   </center><center> </center><p>This graph also clearly shows the slightly better performance when the image size is a multiple of eight. The reason is the size of the NEON registers, which is four words, or eight 16-bit integers. When the number of columns of the foreground image is not a multiple of eight, extra code is needed to process the last pixels of each row, resulting in lower performance.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">#!/usr/bin/env python3.8</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160; </div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160; </div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="keyword">import</span> os.path <span class="keyword">as</span> path</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="keyword">import</span> cv2</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="keyword">import</span> numpy <span class="keyword">as</span> np</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="keyword">import</span> ctypes</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="keyword">import</span> time</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="keyword">import</span> platform</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="keyword">import</span> argparse</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160; </div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;dir = path.dirname(path.realpath(__file__))</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160; </div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;parser = argparse.ArgumentParser(description=<span class="stringliteral">&#39;Benchmark for overlay_alpha&#39;</span>)</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;parser.add_argument(<span class="stringliteral">&#39;--no-simd&#39;</span>, dest=<span class="stringliteral">&#39;SIMD&#39;</span>, action=<span class="stringliteral">&#39;store_false&#39;</span>,</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;                    help=<span class="stringliteral">&#39;Disable SIMD intrinsics&#39;</span>)</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;parser.add_argument(<span class="stringliteral">&#39;--N&#39;</span>, dest=<span class="stringliteral">&#39;N&#39;</span>, type=int, default=25,</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;                    help=<span class="stringliteral">&#39;The number of different sizes to test&#39;</span>)</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;parser.add_argument(<span class="stringliteral">&#39;--min&#39;</span>, dest=<span class="stringliteral">&#39;min_size&#39;</span>, type=int, default=10,</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;                    help=<span class="stringliteral">&#39;The size in pixels of the smallest image in the test&#39;</span>)</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;parser.add_argument(<span class="stringliteral">&#39;--max&#39;</span>, dest=<span class="stringliteral">&#39;max_size&#39;</span>, type=int, default=2000,</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;                    help=<span class="stringliteral">&#39;The size in pixels of the largest image in the test&#39;</span>)</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;parser.add_argument(<span class="stringliteral">&#39;--it&#39;</span>, dest=<span class="stringliteral">&#39;max_iterations&#39;</span>, type=int, default=10,</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;                    help=<span class="stringliteral">&#39;The number of test iterations for the largest images&#39;</span>)</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;parser.add_argument(<span class="stringliteral">&#39;--rescale&#39;</span>, dest=<span class="stringliteral">&#39;rescale&#39;</span>, choices=[<span class="stringliteral">&#39;div255_round&#39;</span>, </div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;                    <span class="stringliteral">&#39;div255_round_approx&#39;</span>, <span class="stringliteral">&#39;div255_floor&#39;</span>, <span class="stringliteral">&#39;div256_round&#39;</span>,</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;                    <span class="stringliteral">&#39;div256_floor&#39;</span>], default=<span class="stringliteral">&#39;div255_round&#39;</span>,</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;                    help=<span class="stringliteral">&#39;The number of test iterations for the largest images&#39;</span>)</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;args = parser.parse_args()</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;print(args)</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160; </div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment"># C types</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;uint8_t_p = ctypes.POINTER(ctypes.c_uint8)</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;size_t = ctypes.c_size_t</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;void = <span class="keywordtype">None</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="comment"># Load the function and declare its signature</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;so = <span class="stringliteral">&quot;libalpha-lib-&quot;</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;so += platform.machine()</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="keywordflow">if</span> <span class="keywordflow">not</span> args.SIMD: so += <span class="stringliteral">&quot;-no-simd&quot;</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;so += <span class="stringliteral">&quot;.so&quot;</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;dll = ctypes.cdll.LoadLibrary(path.join(dir, so))</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;overlay_alpha = dll[<span class="stringliteral">&#39;overlay_alpha_stride_&#39;</span> + args.rescale]</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;overlay_alpha.argtypes = [</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    uint8_t_p,  <span class="comment"># bg_img</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    uint8_t_p,  <span class="comment"># fg_img</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    uint8_t_p,  <span class="comment"># out_img</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    size_t,  <span class="comment"># bg_full_cols</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    size_t,  <span class="comment"># fg_rows</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    size_t,  <span class="comment"># fg_cols</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    size_t,  <span class="comment"># fg_full_cols</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;]</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;overlay_alpha.restype = void</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160; </div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment"># The different image sizes</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;sizes = np.linspace(args.min_size, args.max_size, args.N, dtype=np.int)</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;times = np.zeros((args.N, ))</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160; </div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment"># Run the function for all sizes</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="keywordflow">for</span> i, size <span class="keywordflow">in</span> enumerate(sizes):</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    print(i + 1, <span class="stringliteral">&#39;/&#39;</span>, args.N, <span class="stringliteral">&#39;:&#39;</span>, size)</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160; </div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    <span class="comment"># Generate some random images of the given size</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    bg_img = np.random.randint(255, size=(size, size, 4), dtype=np.uint8)</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    fg_img = np.random.randint(255, size=(size, size, 4), dtype=np.uint8)</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    out_img = np.zeros((size, size, 4), dtype=np.uint8)</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    bg_img_p = bg_img.ctypes.data_as(uint8_t_p)</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    fg_img_p = fg_img.ctypes.data_as(uint8_t_p)</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    out_img_p = out_img.ctypes.data_as(uint8_t_p)</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160; </div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="comment"># Overlay the random images, do it multiple times for accurate timing</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    iterations = <a class="code" href="../../d8/d2f/namespaceperf__test.html#a61569f2965b7a369eb10b6d75d410d11">int</a>(round(args.max_size * args.max_iterations / size))</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    start_time = time.perf_counter()</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(iterations):</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        <a class="code" href="../../d8/d2f/namespaceperf__test.html#ac56bc8f7c417f21a98655611b4b66b9c">overlay_alpha</a>(bg_img_p, fg_img_p, out_img_p, size, size, size, size)</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    end_time = time.perf_counter()</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    times[i] = (end_time - start_time) / iterations</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160; </div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="comment"># Save the results as a CSV file</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;results = np.column_stack((sizes, times))</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;simd = (<span class="stringliteral">&#39; simd &#39;</span> <span class="keywordflow">if</span> args.SIMD <span class="keywordflow">else</span> <span class="stringliteral">&#39; no-simd &#39;</span>)</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;name = str(time.asctime()) + simd + args.rescale + <span class="stringliteral">&#39; &#39;</span> + platform.machine()</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;np.savetxt(name + <span class="stringliteral">&#39;.csv&#39;</span>, results, delimiter=<span class="stringliteral">&#39;,&#39;</span>)</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160; </div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment"># Plot the results</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;plt.plot(sizes, times, <span class="stringliteral">&#39;.-&#39;</span>)</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;plt.xlabel(<span class="stringliteral">&#39;Image size [pixels]&#39;</span>)</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;plt.ylabel(<span class="stringliteral">&#39;Time [s]&#39;</span>)</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;plt.savefig(name + <span class="stringliteral">&#39;.svg&#39;</span>)</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;plt.show()</div>
</div><!-- fragment --> </div><!-- contents -->
<div class="ttc" id="anamespaceperf__test_html_a61569f2965b7a369eb10b6d75d410d11"><div class="ttname"><a href="../../d8/d2f/namespaceperf__test.html#a61569f2965b7a369eb10b6d75d410d11">perf_test.int</a></div><div class="ttdeci">int</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d49/perf__test_8py_source.html#l00066">perf_test.py:66</a></div></div>
<div class="ttc" id="anamespaceperf__test_html_ac56bc8f7c417f21a98655611b4b66b9c"><div class="ttname"><a href="../../d8/d2f/namespaceperf__test.html#ac56bc8f7c417f21a98655611b4b66b9c">perf_test.overlay_alpha</a></div><div class="ttdeci">overlay_alpha</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d49/perf__test_8py_source.html#l00091">perf_test.py:91</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.19
</small></address>
</body>
</html>
